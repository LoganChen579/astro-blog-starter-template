---
import BaseHead from '../components/BaseHead.astro';
import { SITE_TITLE } from '../consts';
---

<!doctype html>
<html lang="zh-cn">
	<head>
		<BaseHead title={`æ·±åº¦æ¢ç´¢ | ${SITE_TITLE}`} description="AIäººç”Ÿè§£æ" />
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
        <script src="https://cdn.staticfile.net/tailwindcss/3.3.5/tailwind.min.js"></script>
		<style is:inline>
            html, body { margin: 0; padding: 0; width: 100%; overflow-x: hidden; background-color: #fdfbf7; }
            .fade-in { animation: fadeIn 0.6s ease-out; }
            @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
            .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); }
            .main-wrapper { padding-top: 20px; padding-bottom: 20px; min-height: 100vh; display: flex; justify-content: center; align-items: flex-start; }
		</style>
	</head>
	<body class="font-sans text-stone-800">
        <div style="position:fixed; top:0; left:0; width:100%; height:100%; z-index:-1; background: url('https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?q=80&w=1200&auto=format&fit=crop') no-repeat center center; background-size: cover; opacity: 0.3;"></div>

        <div class="main-wrapper px-4">
            <div class="max-w-3xl w-full bg-white/95 backdrop-blur-xl shadow-2xl rounded-3xl overflow-hidden border border-stone-200 flex flex-col" style="min-height: 85vh;">
                <div class="w-full bg-stone-100 h-2"><div id="progress-bar" class="bg-stone-800 h-2 transition-all duration-500" style="width: 0%"></div></div>

                <div class="p-6 border-b border-stone-100 bg-white/80 sticky top-0 z-30 shadow-sm flex justify-between items-center">
                    <a href="/" class="text-xl font-bold text-stone-800 tracking-tight">â† äººç”Ÿè¯´æ˜ä¹¦</a>
                    <div class="flex gap-1"><div class="w-3 h-3 rounded-full bg-red-400"></div><div class="w-3 h-3 rounded-full bg-blue-400"></div><div class="w-3 h-3 rounded-full bg-yellow-400"></div></div>
                </div>

                <div id="app" class="flex-1 p-6 overflow-y-auto pb-20 scroll-smooth relative">
                    <!-- Step 0 -->
                    <div id="step-0" class="fade-in h-full flex flex-col justify-center items-center text-center space-y-8 py-12">
                        <div class="text-7xl">ğŸ§¬</div>
                        <div><h2 class="text-3xl font-bold text-stone-800 mb-3">å¯»æ‰¾å‡ºå‚è®¾ç½®</h2><p class="text-stone-500 text-sm">16 ä¸ªæ½œæ„è¯†æ¢é’ˆ Â· AI æ·±åº¦è§£æ</p></div>
                        <div class="w-full max-w-xs space-y-4">
                            <input type="text" id="user-name" placeholder="è¯·è¾“å…¥ä½ çš„åå­—" class="w-full p-4 bg-stone-50 border border-stone-200 rounded-xl text-center focus:border-stone-800 outline-none transition font-bold text-lg">
                            <button onclick="start()" class="w-full bg-stone-800 text-white py-4 rounded-xl hover:bg-stone-900 transition font-bold shadow-lg text-lg">å¼€å§‹è§£æ</button>
                        </div>
                    </div>

                    <!-- Form -->
                    <div id="form-container" class="hidden fade-in">
                        <div class="flex items-center gap-3 mb-8">
                            <span id="chapter-badge" class="bg-stone-800 text-white px-3 py-1 rounded text-xs font-bold">PART 1</span>
                            <div><h2 id="chapter-title" class="text-2xl font-bold text-stone-800"></h2><p id="section-desc" class="text-sm text-stone-500 mt-1"></p></div>
                        </div>
                        <div id="questions-list" class="space-y-12"></div>
                    </div>

                    <!-- Loading -->
                    <div id="loading-screen" class="hidden h-full flex flex-col justify-center items-center text-center fade-in py-20">
                        <div class="animate-spin text-5xl mb-6">â³</div>
                        <h3 class="text-2xl font-bold text-stone-800">æ­£åœ¨è¿æ¥æ½œæ„è¯†...</h3>
                        <p class="text-stone-500 text-sm mt-4">AI æ­£åœ¨åˆ†æä½ çš„ 16 ä¸ªå›ç­”...</p>
                    </div>

                    <!-- Result -->
                    <div id="result-screen" class="hidden fade-in space-y-10 pb-10">
                        <div class="text-center border-b border-stone-100 pb-6">
                            <h2 class="text-3xl font-bold text-stone-800">åˆ†ææŠ¥å‘Š</h2>
                            <p class="text-stone-500 text-sm mt-2">å—æµ‹è€…: <span id="res-name" class="font-bold text-black text-lg"></span></p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-red-50 p-5 rounded-2xl border border-red-100 text-center"><div class="text-xs font-black text-red-400 mb-2">VALUES</div><div id="kw-values" class="text-lg font-bold text-red-900"></div></div>
                            <div class="bg-blue-50 p-5 rounded-2xl border border-blue-100 text-center"><div class="text-xs font-black text-blue-400 mb-2">TALENTS</div><div id="kw-talents" class="text-lg font-bold text-blue-900"></div></div>
                            <div class="bg-yellow-50 p-5 rounded-2xl border border-yellow-100 text-center"><div class="text-xs font-black text-yellow-600 mb-2">PASSION</div><div id="kw-passion" class="text-lg font-bold text-yellow-900"></div></div>
                        </div>
                        <div class="bg-stone-900 text-white p-8 rounded-3xl shadow-xl text-center space-y-6">
                            <p class="text-lg text-stone-300">åœ¨ <span id="f-passion" class="text-yellow-400 font-bold"></span> é¢†åŸŸ</p>
                            <p class="text-lg text-stone-300">åˆ©ç”¨ <span id="f-talent" class="text-blue-400 font-bold"></span></p>
                            <p class="text-2xl font-bold text-white mt-4">å»å®ç° <span id="f-value" class="text-red-500 bg-white/10 px-3 py-1 rounded-lg"></span></p>
                        </div>
                        <div class="bg-white border border-stone-200 p-6 rounded-2xl">
                            <h3 class="font-bold text-stone-800 mb-4">ğŸ’¼ èŒä¸šå»ºè®®</h3>
                            <p id="res-advice" class="text-sm text-stone-600 leading-loose whitespace-pre-line"></p>
                        </div>
                        <button onclick="location.reload()" class="w-full py-4 bg-stone-50 border border-stone-200 rounded-xl font-bold text-stone-500">é‡æ–°æµ‹è¯•</button>
                    </div>
                </div>

                <div id="footer-nav" class="hidden p-4 border-t border-stone-100 bg-white/90 sticky bottom-0 z-20 flex gap-3">
                    <button onclick="prevSection()" id="prev-btn" class="flex-1 bg-white border border-stone-200 text-stone-600 py-3 rounded-xl font-bold">â† ä¸Šä¸€æ­¥</button>
                    <button onclick="nextSection()" id="next-btn" class="flex-[2] bg-stone-800 text-white py-3 rounded-xl font-bold shadow-lg">ä¸‹ä¸€æ­¥ â†’</button>
                </div>

                <!-- Modal -->
                <div id="hint-modal" class="fixed inset-0 z-50 hidden modal-backdrop flex items-center justify-center px-4">
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 relative">
                        <button onclick="closeHint()" class="absolute top-4 right-4 text-2xl">&times;</button>
                        <h3 class="text-lg font-bold mb-4">ğŸ’¡ æ€è·¯é”¦å›Š</h3>
                        <div class="space-y-4 text-sm leading-relaxed">
                            <div class="bg-yellow-50 p-3 rounded text-yellow-900" id="modal-intent"></div>
                            <div class="whitespace-pre-line" id="modal-guide"></div>
                            <div id="modal-ai-section" class="hidden border-t pt-3 mt-3"><strong class="text-blue-600">ğŸ¤– AI å»ºè®®:</strong><p id="modal-ai-content" class="mt-1 text-stone-700"></p></div>
                        </div>
                        <button onclick="closeHint()" class="mt-6 bg-stone-800 text-white w-full py-3 rounded-xl font-bold">æˆ‘æ˜ç™½äº†</button>
                    </div>
                </div>
            </div>
        </div>

        <script is:inline>
            const API_URL = "/api/ai"; 
            let currentSectionIdx = 0, userName = "", userAnswers = {};
            
            const chapters = [
                { id: "values", name: "ä»·å€¼è§‚", desc: "ä½ æœ€çœ‹é‡ä»€ä¹ˆï¼Ÿ", questions: [
                    { q: "1. ä½ å°Šæ•¬çš„äººæ˜¯è°ï¼Ÿ", intent: "ç›´è§‰æ˜¯è°å°±æ˜¯è°ã€‚", guide: "åˆ«ç®¡ä»–ä¼Ÿä¸ä¼Ÿå¤§ï¼Œè„‘å­é‡Œè¹¦å‡ºçš„ç¬¬ä¸€ä¸ªäººã€‚" },
                    { q: "2. ä¸ºä»€ä¹ˆå°Šæ•¬ä»–ï¼Ÿ", intent: "å½¢å®¹è¯æ‰æ˜¯é‡ç‚¹ã€‚", guide: "ä»–å“ªä¸€ç‚¹æ‰“åŠ¨äº†ä½ ï¼Ÿ" },
                    { q: "3. é’æ˜¥æœŸå½±å“æœ€å¤§çš„äº‹ï¼Ÿ", intent: "ä¸–ç•Œè§‚å†²å‡»ã€‚", guide: "è§‰å¾—ç‰¹åˆ«ä¸å…¬å¹³ï¼Œæˆ–ç‰¹åˆ«æƒ³æ´»æˆé‚£æ ·çš„æ—¶åˆ»ã€‚" },
                    { q: "4. è§‰å¾—ç¤¾ä¼šç¼ºä»€ä¹ˆï¼Ÿ", intent: "ä½ æƒ³æ”¹å˜ä»€ä¹ˆã€‚", guide: "å¦‚æœä½ æœ‰é­”æ³•ï¼Œä½ æƒ³æ”¹ç¤¾ä¼šå“ªä¸€ç‚¹ï¼Ÿ" },
                    { q: "5. æœ‹å‹è§‰å¾—ä½ çœ‹é‡ä»€ä¹ˆï¼Ÿ", intent: "å®¢è§‚è§†è§’ã€‚", guide: "å‘å¾®ä¿¡é—®æ­»å…šï¼šâ€˜ä½ è§‰å¾—æˆ‘æœ€çœ‹é‡ä»€ä¹ˆï¼Ÿâ€™" },
                    { q: "6. ç»™èº«è¾¹äººçš„å»ºè®®ï¼Ÿ", intent: "ä½ å¸¸æŒ‚å˜´è¾¹çš„è¯ã€‚", guide: "ä½ æ€»å¿ä¸ä½æƒ³çº æ­£åˆ«äººä»€ä¹ˆï¼Ÿ" }
                ]},
                { id: "talents", name: "æ‰èƒ½", desc: "ä½ è§‰å¾—ç®€å•åˆ«äººè§‰å¾—éš¾çš„äº‹", questions: [
                    { q: "7. æœ€å……å®çš„ç»å†ï¼Ÿ", intent: "å¿˜æˆ‘çš„æ—¶åˆ»ã€‚", guide: "ä»€ä¹ˆæ—¶å€™ä½ ä¼šå¿˜è®°åƒé¥­çœ‹æ‰‹æœºï¼Ÿ" },
                    { q: "8. æœ€è¿‘æ„Ÿåˆ°ä¸è€çƒ¦çš„äº‹ï¼Ÿ", intent: "ä½ è§‰å¾—ç®€å•ä»–åšä¸å¥½ã€‚", guide: "è°åšäº‹ç¬¨æ‰‹ç¬¨è„šè®©ä½ ç«å¤§ï¼Ÿ" },
                    { q: "9. åˆ«äººå¤¸ä½ ä»€ä¹ˆï¼Ÿ", intent: "æ— æ„è¯†çš„ä¼˜ç‚¹ã€‚", guide: "æœ‹å‹å¸¸å¤¸ä½ ç»†å¿ƒè¿˜æ˜¯ç‚¹å­å¤šï¼Ÿ" },
                    { q: "10. ä¸å·¥ä½œæƒ³åšä»€ä¹ˆï¼Ÿ", intent: "æœ¬èƒ½é©±åŠ¨ã€‚", guide: "ä¸­å½©ç¥¨åç©è…»äº†ï¼Œä½ æƒ³ç¢ç£¨ç‚¹ä»€ä¹ˆï¼Ÿ" },
                    { q: "11. åšè¿‡æœ€æˆåŠŸçš„äº‹ï¼Ÿ", intent: "èƒœä»»æ„Ÿã€‚", guide: "å“ªä»¶äº‹åšå®Œè§‰å¾—è‡ªå·±æŒºè¡Œï¼Ÿ" }
                ]},
                { id: "passion", name: "çƒ­æƒ…", desc: "æ„¿æ„ä»˜å‡ºä»£ä»·çš„äº‹", questions: [
                    { q: "12. æ„¿æ„èŠ±é’±å­¦ä»€ä¹ˆï¼Ÿ", intent: "çœŸçˆ±éœ€ä»£ä»·ã€‚", guide: "ç¬¬ä¸€ååº”æŠ¥ä»€ä¹ˆç­ï¼Ÿ" },
                    { q: "13. ä¹¦æ¶/æµè§ˆè®°å½•æœ€å¤šçš„å†…å®¹ï¼Ÿ", intent: "çœŸå®å¥½å¥‡å¿ƒã€‚", guide: "æ‰“å¼€æŠ–éŸ³/Bç«™ï¼Œæ¨èç»™ä½ æœ€å¤šçš„åˆ†ç±»ï¼Ÿ" },
                    { q: "14. æ•‘è¿‡ä½ çš„å†…å®¹/çŸ¥è¯†ï¼Ÿ", intent: "ä½è°·æœŸçš„å…‰ã€‚", guide: "åªèƒ½ç•™ä¸€æœ¬ä¹¦ï¼Œä½ ç•™å“ªæœ¬ï¼Ÿ" },
                    { q: "15. æƒ³æ„Ÿè°¢çš„äººæˆ–äº‹ï¼Ÿ", intent: "æ„Ÿæ¿€æºå¤´ã€‚", guide: "è°çš„å¸®åŠ©è®©ä½ ç°åœ¨å¿ƒé‡Œè¿˜æš–æš–çš„ï¼Ÿ" },
                    { q: "16. å¯¹ä¸–ç•Œæœ‰ä»€ä¹ˆä¸æ»¡ï¼Ÿ", intent: "æ·±å±‚æ„¿æœ›ã€‚", guide: "å¦‚æœè¿™ä¸–ç•Œå°‘ä¸€æ ·ä¸œè¥¿ä¼šæ›´å¥½ï¼Œæ˜¯ä»€ä¹ˆï¼Ÿ" }
                ]}
            ];
            chapters.forEach(c => { userAnswers[c.id] = new Array(c.questions.length).fill(""); });

            function start() {
                const name = document.getElementById('user-name').value.trim();
                if(!name) return alert("è¯·è¾“å…¥åå­—");
                userName = name;
                document.getElementById('step-0').classList.add('hidden');
                document.getElementById('form-container').classList.remove('hidden');
                document.getElementById('footer-nav').classList.remove('hidden'); document.getElementById('footer-nav').classList.add('flex');
                renderSection();
            }

            function renderSection() {
                const section = chapters[currentSectionIdx];
                const container = document.getElementById('questions-list');
                container.innerHTML = ""; 
                document.getElementById('chapter-badge').innerText = `PART ${currentSectionIdx+1}`;
                document.getElementById('chapter-title').innerText = section.name;
                document.getElementById('section-desc').innerText = section.desc;
                document.getElementById('progress-bar').style.width = `${((currentSectionIdx)/3)*100}%`;
                document.getElementById('prev-btn').style.display = currentSectionIdx===0?'none':'block';
                document.getElementById('next-btn').innerText = currentSectionIdx===2?"âœ¨ ç”ŸæˆæŠ¥å‘Š":"ä¸‹ä¸€æ­¥ â†’";

                section.questions.forEach((item, idx) => {
                    const val = userAnswers[section.id][idx] || "";
                    container.innerHTML += `
                        <div class="bg-stone-50 p-6 rounded-xl border border-stone-100">
                            <div class="mb-3 font-bold text-stone-800">${item.q}</div>
                            <textarea id="input-${idx}" rows="3" class="w-full p-4 border rounded-lg text-sm" placeholder="ä½ çš„å›ç­”..." onblur="saveInput(${idx})">${val}</textarea>
                            <div class="flex justify-end gap-2 mt-3">
                                <button onclick="askAI(${idx}, 'hint')" class="text-xs bg-white border px-3 py-1 rounded-full text-stone-500">ğŸ¤– AIæ€è·¯</button>
                                <button onclick="askAI(${idx}, 'refine')" class="text-xs bg-white border px-3 py-1 rounded-full text-stone-500">âœ¨ æ¶¦è‰²</button>
                            </div>
                        </div>`;
                });
                document.getElementById('app').scrollTo(0,0);
            }

            function saveInput(idx) { userAnswers[chapters[currentSectionIdx].id][idx] = document.getElementById(`input-${idx}`).value; }
            function saveAll() { 
                const list = document.querySelectorAll('textarea');
                let hasVal = false;
                list.forEach((el, i) => { userAnswers[chapters[currentSectionIdx].id][i] = el.value; if(el.value.trim()) hasVal=true; });
                return hasVal;
            }

            function prevSection() { saveAll(); if(currentSectionIdx>0){currentSectionIdx--; renderSection();} }
            async function nextSection() {
                if(!saveAll()) return alert("è¯·è‡³å°‘å›ç­”ä¸€ä¸ªé—®é¢˜");
                if(currentSectionIdx<2) { currentSectionIdx++; renderSection(); }
                else { await submit(); }
            }

            async function askAI(idx, type) {
                const qData = chapters[currentSectionIdx].questions[idx];
                const val = document.getElementById(`input-${idx}`).value;
                if(type==='refine' && !val) return alert("è¯·å…ˆå†™ç‚¹å†…å®¹");
                
                try {
                    const res = await fetch(API_URL, {
                        method: "POST", headers: {"Content-Type":"application/json"},
                        body: JSON.stringify({ 
                            action: type, 
                            data: { question: qData.q, theory_context: qData.intent, text: val },
                            context: chapters[currentSectionIdx].name 
                        })
                    });
                    const json = await res.json();
                    if(type==='hint') {
                        document.getElementById('hint-modal').classList.remove('hidden');
                        document.getElementById('modal-intent').innerText = qData.intent;
                        document.getElementById('modal-guide').innerText = qData.guide;
                        document.getElementById('modal-ai-section').classList.remove('hidden');
                        document.getElementById('modal-ai-content').innerText = json.data;
                    } else {
                        document.getElementById(`input-${idx}`).value = json.data;
                    }
                } catch(e) { alert("AI è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ"); }
            }
            function closeHint() { document.getElementById('hint-modal').classList.add('hidden'); }

            async function submit() {
                document.getElementById('form-container').classList.add('hidden');
                document.getElementById('footer-nav').classList.add('hidden');
                document.getElementById('loading-screen').classList.remove('hidden');
                document.getElementById('progress-bar').style.width = "100%";

                try {
                    const res = await fetch(API_URL, {
                        method: "POST", headers: {"Content-Type":"application/json"},
                        body: JSON.stringify({
                            action: 'analyze', user_name: userName, answers: userAnswers,
                            system_prompt: `ä½ æ˜¯ä¸€ä½ç²¾é€šå…«æœ¨ä»å¹³ç†è®ºçš„äººç”Ÿè§„åˆ’å¸ˆã€‚è¯·åˆ†æç”¨æˆ·å›ç­”ï¼Œè¿”å›JSONæ ¼å¼ï¼š
                            { "values": "å…³é”®è¯", "talents": "å…³é”®è¯", "passion": "å…³é”®è¯", 
                              "formula_sentence": { "passion": "é¢†åŸŸ", "talent": "æ‰‹æ®µ", "value": "ç›®çš„" },
                              "advice": "å»ºè®®" }`
                        })
                    });
                    const json = await res.json();
                    const r = json.data;
                    
                    document.getElementById('loading-screen').classList.add('hidden');
                    document.getElementById('result-screen').classList.remove('hidden');
                    
                    document.getElementById('res-name').innerText = userName;
                    document.getElementById('kw-values').innerText = r.values||"";
                    document.getElementById('kw-talents').innerText = r.talents||"";
                    document.getElementById('kw-passion').innerText = r.passion||"";
                    if(r.formula_sentence) {
                        document.getElementById('f-passion').innerText = r.formula_sentence.passion;
                        document.getElementById('f-talent').innerText = r.formula_sentence.talent;
                        document.getElementById('f-value').innerText = r.formula_sentence.value;
                    }
                    document.getElementById('res-advice').innerText = r.advice||"";

                } catch(e) { 
                    alert("ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•");
                    location.reload();
                }
            }
        </script>
	</body>
</html>
