<script>
    // ==========================================
    // 1. å®šä¹‰é¢˜ç›®ä¸â€œè€é«˜â€çš„ç‹¬å®¶å¼•å¯¼é€»è¾‘
    // ==========================================
    const questions = [
        // --- ä»·å€¼è§‚ç¯‡ ---
        {
            id: 1,
            text: "ä½ å°Šæ•¬çš„äººæ˜¯è°ï¼Ÿ(â˜… èµ·ç‚¹é—®é¢˜)",
            hintPrompt: "è¯·åŸºäºè€é«˜çš„è§‚ç‚¹å¼•å¯¼æˆ‘ï¼šä¸è¦æƒ³å¤ªä¹…ï¼Œç›´è§‰æ˜¯è°å°±æ˜¯è°ã€‚ä¸ç®¡æ˜¯åäººã€çˆ¶æ¯è¿˜æ˜¯æ¼«ç”»äººç‰©(å¦‚è·¯é£)ã€‚é‡è¦çš„æ˜¯æ­¤æ—¶æ­¤åˆ»è„‘å­é‡Œè¹¦å‡ºæ¥çš„ç¬¬ä¸€ä¸ªåå­—ã€‚ä¸è¦ç­›é€‰ï¼Œä¸è¦ç®¡ä»–å¤Ÿä¸å¤Ÿä¼Ÿå¤§ã€‚"
        },
        {
            id: 2,
            text: "ä¸ºä»€ä¹ˆå°Šæ•¬ä»–ï¼Ÿ/ å–œæ¬¢ä»–ä»€ä¹ˆåœ°æ–¹ï¼Ÿ",
            hintPrompt: "è¯·åŸºäºè€é«˜çš„è§‚ç‚¹å¼•å¯¼æˆ‘ï¼šåå­—ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯â€˜ä¸ºä»€ä¹ˆâ€™ã€‚å¼•å¯¼æˆ‘æ‰¾å‡ºå…·ä½“çš„å½¢å®¹è¯å…³é”®è¯ã€‚æ˜¯å› ä¸ºä»–â€˜è‡ªç”±â€™ï¼Ÿè¿˜æ˜¯â€˜ä»æœªæ”¾å¼ƒâ€™ï¼Ÿè¿™äº›å½¢å®¹è¯æ‰æ˜¯æˆ‘çš„ä»·å€¼è§‚ã€‚"
        },
        {
            id: 3,
            text: "é’æ˜¥æœŸå¯¹ä½ å½±å“å¾ˆå¤§çš„äº‹æƒ…æ˜¯ä»€ä¹ˆï¼Ÿ",
            hintPrompt: "è¯·åŸºäºè€é«˜çš„è§‚ç‚¹å¼•å¯¼æˆ‘ï¼šå›æƒ³åˆé«˜ä¸­æ—¶æœŸï¼Œæœ‰æ²¡æœ‰å¯¹ä¸‰è§‚äº§ç”Ÿå†²å‡»çš„äº‹ï¼Ÿé‚£æ—¶å€™æ„Ÿæ€§æœ€ä¸°å¯Œã€‚æœ‰æ²¡æœ‰è§‰å¾—ç‰¹åˆ«ä¸å…¬å¹³çš„äº‹ï¼Ÿæˆ–è€…è®©ä½ ç¬é—´è§‰å¾—â€˜æˆ‘å°±è¦è¿™æ ·æ´»â€™çš„æ—¶åˆ»ï¼Ÿ"
        },
        {
            id: 4,
            text: "ä½ è§‰å¾—ç°åœ¨ç¤¾ä¼šæœ‰ä»€ä¹ˆä¸è¶³çš„åœ°æ–¹ï¼Ÿ",
            hintPrompt: "è¯·åŸºäºè€é«˜çš„è§‚ç‚¹å¼•å¯¼æˆ‘ï¼šä½ è§‰å¾—ç¤¾ä¼šç¼ºä»€ä¹ˆï¼Ÿæˆ–è€…çœ‹ä¸æƒ¯å“ªé‡Œï¼Ÿå¼•å¯¼æˆ‘æ€è€ƒï¼šå¦‚æœæœ‰é­”æ³•ï¼Œæˆ‘æƒ³æ”¹å˜ç¤¾ä¼šçš„ä¸€ä¸ªä»€ä¹ˆç°çŠ¶ï¼Ÿæˆ‘æƒ³è¡¥å…¨çš„é‚£ä¸ªä¸œè¥¿ï¼Œå°±æ˜¯æˆ‘æœ€çœ‹é‡çš„ä»·å€¼ã€‚"
        },
        {
            id: 5,
            text: "åœ¨æœ‹å‹çœ¼é‡Œä½ æ˜¯ä¸€ä¸ªçœ‹ä¸­ä»€ä¹ˆä¸œè¥¿çš„äººï¼Ÿ",
            hintPrompt: "è¯·åŸºäºè€é«˜çš„è§‚ç‚¹å¼•å¯¼æˆ‘ï¼šå¼ºè°ƒè¿™é¢˜å¿…é¡»é—®åˆ«äººã€‚æˆ‘è‡ªå·±æƒ³çš„ä¸ç®—ã€‚å¼•å¯¼æˆ‘å»å‘å¾®ä¿¡é—®æ­»å…šï¼šâ€˜ä½ è§‰å¾—æˆ‘æœ€çœ‹é‡ä»€ä¹ˆï¼Ÿâ€™ ä»–ä»¬çš„å›ç­”å¾€å¾€æ‰æ˜¯çœŸç›¸ã€‚"
        },
        {
            id: 6,
            text: "ç»™èº«è¾¹äººçš„å»ºè®®ï¼Ÿ/ ä¸å¸Œæœ›æœ‹å‹ç»™ä½ ä»€ä¹ˆæ ·çš„å»ºè®®ï¼Ÿ",
            hintPrompt: "è¯·åŸºäºè€é«˜çš„è§‚ç‚¹å¼•å¯¼æˆ‘ï¼šæˆ‘ç»å¸¸æŒ‚åœ¨å˜´è¾¹åŠåˆ«äººçš„è¯æ˜¯ä»€ä¹ˆï¼Ÿæˆ–è€…åˆ«äººåŠæˆ‘ä»€ä¹ˆæ—¶ï¼Œæˆ‘å¿ƒé‡Œä¼šæƒ³â€˜çƒ¦æ­»äº†åˆ«ç®¡æˆ‘â€™ï¼Ÿï¼ˆä¾‹å¦‚ï¼šåŠæˆ‘è¦åˆç¾¤è¿˜æ˜¯åŠæˆ‘è¦ä¸Šè¿›ï¼Ÿï¼‰"
        },

        // --- æ‰èƒ½ç¯‡ ---
        {
            id: 7,
            text: "ç›®å‰äººç”Ÿæœ€å……å®çš„ç»å†æ˜¯ä»€ä¹ˆï¼Ÿ",
            hintPrompt: "è¯·åŸºäºè€é«˜çš„è§‚ç‚¹å¼•å¯¼æˆ‘ï¼šå“ªæ®µæ—¶é—´è¿‡å¾—ç‰¹å¿«ï¼Ÿä»€ä¹ˆæ—¶å€™åšäº‹æƒ…ä¼šå¿˜è®°çœ‹æ‰‹æœºã€å¿˜è®°åƒé¥­ï¼Ÿé‚£ç§â€˜é¡ºæ‰‹â€™çš„æ„Ÿè§‰æ˜¯åœ¨åšä»€ä¹ˆï¼Ÿ"
        },
        {
            id: 8,
            text: "æœ€è¿‘ä¸€æ¬¡ä¸è€çƒ¦çš„äº‹æƒ…ï¼ˆâ˜… æŒ–æ˜å¤©èµ‹æœ€å¿«çš„ä¸€é¢˜ï¼‰",
            hintPrompt: "è¯·åŸºäºè€é«˜çš„è§‚ç‚¹å¼•å¯¼æˆ‘ï¼šæ³¨æ„ï¼çœ‹è§è°åšäº‹ç¬¨æ‰‹ç¬¨è„šè®©æˆ‘ç«å¤§ï¼Ÿå¿ƒé‡Œæƒ³â€˜è¿™ç©æ„è¿™ä¹ˆç®€å•ä½ æ€ä¹ˆåšä¸å¥½â€™ï¼Ÿå¼•å¯¼æˆ‘æŒ–æ˜ï¼šé‚£ä¸ªæˆ‘è§‰å¾—ç®€å•ä½†ä»–åšä¸å¥½çš„äº‹ï¼Œå°±æ˜¯æˆ‘çš„æ‰èƒ½ã€‚"
        },
        {
            id: 9,
            text: "é—®èº«è¾¹çš„äººè‡ªå·±æ“…é•¿ä»€ä¹ˆï¼Ÿ",
            hintPrompt: "è¯·åŸºäºè€é«˜çš„è§‚ç‚¹å¼•å¯¼æˆ‘ï¼šæ‰èƒ½åƒå‘¼å¸ä¸€æ ·æ— æ„è¯†ã€‚å¼•å¯¼æˆ‘å»é—®åˆ«äººï¼šâ€˜ä½ è§‰å¾—æˆ‘å¹²ä»€ä¹ˆæœ€å‰å®³ï¼Ÿâ€™ æ˜¯â€˜ä½ çœŸç»†å¿ƒâ€™è¿˜æ˜¯â€˜ä½ ç‚¹å­çœŸå¤šâ€™ï¼Ÿ"
        },
        {
            id: 10,
            text: "æ”¾å¼ƒç°åœ¨çš„å·¥ä½œç‰¹åˆ«æƒ³åšçš„äº‹æƒ…ï¼Ÿ",
            hintPrompt: "è¯·åŸºäºè€é«˜çš„è§‚ç‚¹å¼•å¯¼æˆ‘ï¼šå¦‚æœæ²¡æœ‰é’±çš„é—®é¢˜ï¼Œæˆ‘æœ¬èƒ½æƒ³å¹²ä»€ä¹ˆï¼Ÿå‡è®¾ä¸­äº†å½©ç¥¨ï¼Œç©è…»äº†ä¹‹åï¼Œæ¯å¤©æ—©ä¸Šèµ·æ¥æƒ³ç¢ç£¨ç‚¹ä»€ä¹ˆäº‹æ¥æ‰“å‘æ—¶é—´ï¼Ÿ"
        },
        {
            id: 11,
            text: "ç›®å‰ä¸ºæ­¢æˆåŠŸçš„äº‹æƒ…ï¼Ÿ",
            hintPrompt: "è¯·åŸºäºè€é«˜çš„è§‚ç‚¹å¼•å¯¼æˆ‘ï¼šä¸éœ€è¦å¤§æˆåŠŸã€‚å“ªæ€•æ˜¯å°å­¦å¾—å°çº¢èŠ±ï¼Œæˆ–è€…å¸®æœ‹å‹è§£å†³äº†ä¸€ä¸ªéº»çƒ¦ã€‚å“ªä»¶äº‹åšå®Œè®©æˆ‘è§‰å¾—è‡ªå·±â€˜æŒºè¡Œâ€™çš„ï¼Ÿ"
        },

        // --- çƒ­æƒ…ç¯‡ ---
        {
            id: 12,
            text: "ä»€ä¹ˆäº‹æƒ…å°±ç®—èŠ±é’±ä¹Ÿæ„¿æ„å»å­¦ï¼Ÿ",
            hintPrompt: "è¯·åŸºäºè€é«˜çš„è§‚ç‚¹å¼•å¯¼æˆ‘ï¼šçœŸçš„çƒ­æƒ…æ˜¯éœ€è¦èŠ±ä»£ä»·çš„ã€‚å¦‚æœç°åœ¨ç»™æˆ‘ä¸€ç¬”é’±è§„å®šåªèƒ½æŠ¥ç­å­¦ä¹ ï¼Œæˆ‘ç¬¬ä¸€ååº”æ˜¯å»æŠ¥ä»€ä¹ˆç­ï¼Ÿ"
        },
        {
            id: 13,
            text: "ä½ çš„ä¹¦æ¶ä¸Šæœ‰ä»€ä¹ˆå†…å®¹çš„ä¹¦ï¼Ÿ",
            hintPrompt: "è¯·åŸºäºè€é«˜çš„è§‚ç‚¹å¼•å¯¼æˆ‘ï¼šç¿»ç¿»ä¹¦æ¶æˆ–æµè§ˆè®°å½•ã€‚é‚£äº›æˆ‘â€˜ä¹°å›æ¥â€™çš„ä¿¡æ¯æš´éœ²äº†çœŸæ­£çš„å¥½å¥‡å¿ƒã€‚æˆ‘çœ‹é—²ç€æ²¡äº‹å°±æƒ³ç‚¹å¼€å“ªç±»è§†é¢‘ï¼Ÿæ˜¯å†å²ï¼Ÿæœºæ¢°ï¼Ÿè¿˜æ˜¯å¿ƒç†å­¦ï¼Ÿ"
        },
        {
            id: 14,
            text: "ä»€ä¹ˆå†…å®¹ç»™ä½ å¾ˆå¤§çš„å¸®åŠ©ï¼Ÿ",
            hintPrompt: "è¯·åŸºäºè€é«˜çš„è§‚ç‚¹å¼•å¯¼æˆ‘ï¼šæœ‰æ²¡æœ‰ä¸€æœ¬ä¹¦æˆ–ç”µå½±åœ¨ä½è°·æ—¶æ•‘è¿‡æˆ‘ï¼Ÿå¦‚æœæˆ¿å­ç€ç«åªèƒ½å¸¦èµ°ä¸€ä¸ªå†…å®¹ï¼Œæˆ‘ä¼šé€‰å“ªä¸ªï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ"
        },
        {
            id: 15,
            text: "ä½ æœ‰æƒ³è¦æ„Ÿè°¢çš„äººå’Œäº‹ä¹ˆï¼Ÿ",
            hintPrompt: "è¯·åŸºäºè€é«˜çš„è§‚ç‚¹å¼•å¯¼æˆ‘ï¼šæˆ‘æƒ³å¯¹è°è¯´è°¢è°¢ï¼Ÿé‚£ä¸ªè®©æˆ‘æ„Ÿæ¿€çš„æºå¤´ï¼Œé€šå¸¸è¿ç€æˆ‘çš„çƒ­æƒ…ã€‚ä»–å¸®äº†æˆ‘ä»€ä¹ˆï¼Ÿé‚£ä¸ªç‚¹å¾€å¾€æ˜¯æˆ‘ä¹Ÿæƒ³å¸¦ç»™åˆ«äººçš„ã€‚"
        },
        {
            id: 16,
            text: "ä½ å¯¹è¿™ä¸ªä¸–ç•Œæœ‰ä»€ä¹ˆä¸æ»¡ä¹ˆï¼Ÿ",
            hintPrompt: "è¯·åŸºäºè€é«˜çš„è§‚ç‚¹å¼•å¯¼æˆ‘ï¼šè¿™æ¯”ç¤¾ä¼šä¸è¶³æ›´å¤§ã€‚æˆ‘å¯¹ä¸–ç•Œæœ‰ä»€ä¹ˆæ„¤æ€’ï¼Ÿå¦‚æœæ˜¯ç¥ï¼Œæˆ‘æœ€æƒ³æ¶ˆç­ä»€ä¹ˆï¼Ÿï¼ˆè´«ç©·ã€æˆ˜äº‰ã€è¿˜æ˜¯ä¸‘é™‹çš„è®¾è®¡ï¼Ÿï¼‰"
        }
    ];

    let currentStep = 0;
    const answers = new Array(questions.length).fill('');
    
    // DOM å…ƒç´ å¼•ç”¨
    const questionText = document.getElementById('question-text');
    const stepIndicator = document.getElementById('step-indicator');
    const inputArea = document.getElementById('answer-input') as HTMLTextAreaElement;
    const nextBtn = document.getElementById('next-btn');
    const prevBtn = document.getElementById('prev-btn');
    const submitBtn = document.getElementById('submit-btn');
    const hintBtn = document.getElementById('hint-btn');
    const hintBox = document.getElementById('hint-box');
    const hintContent = document.getElementById('hint-content');
    const formSection = document.getElementById('form-section');
    const reportSection = document.getElementById('report-section');
    const reportContent = document.getElementById('report-content');

    // åˆå§‹åŒ–ç¬¬ä¸€é¢˜
    updateUI();

    // ç›‘å¬è¾“å…¥ï¼Œæ§åˆ¶æŒ‰é’®çŠ¶æ€
    inputArea.addEventListener('input', (e) => {
        const val = (e.target as HTMLTextAreaElement).value;
        answers[currentStep] = val;
        // æœ‰å†…å®¹æ‰èƒ½ç‚¹ä¸‹ä¸€æ­¥
        if(nextBtn) (nextBtn as HTMLButtonElement).disabled = val.trim() === '';
        if(submitBtn) (submitBtn as HTMLButtonElement).disabled = val.trim() === '';
    });

    // ä¸‹ä¸€æ­¥
    if(nextBtn) nextBtn.addEventListener('click', () => {
        if (currentStep < questions.length - 1) {
            currentStep++;
            updateUI();
        }
    });

    // ä¸Šä¸€æ­¥
    if(prevBtn) prevBtn.addEventListener('click', () => {
        if (currentStep > 0) {
            currentStep--;
            updateUI();
        }
    });

    // æäº¤ç”ŸæˆæŠ¥å‘Š
    if(submitBtn) submitBtn.addEventListener('click', generateReport);

    // ç‚¹å‡»â€œæ²¡æ€è·¯â€æŒ‰é’®
    if(hintBtn) hintBtn.addEventListener('click', askAI);

    // ==========================================
    // 2. æ ¸å¿ƒå‡½æ•°ï¼šæ±‚åŠ© AI (è¯·æ±‚ /api/ai)
    // ==========================================
    async function askAI() {
        const currentQ = questions[currentStep];

        // UI çŠ¶æ€åˆ‡æ¢
        hintBtn.disabled = true;
        hintBtn.innerText = "è€é«˜æ€è€ƒä¸­...";
        hintBox.classList.remove('hidden');
        hintContent.innerHTML = '<span class="loading-dots">æ­£åœ¨è¿æ¥æ€ç»´åº“...</span>';

        try {
            // â˜…â˜…â˜… æ³¨æ„è¿™é‡Œï¼šå·²ç»æ”¹æˆäº† /api/ai â˜…â˜…â˜…
            const response = await fetch('/api/ai', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    type: 'hint', 
                    prompt: currentQ.hintPrompt 
                }) 
            });

            const data = await response.json();
            
            // ğŸ§¹ æ ¼å¼æ¸…æ´—
            let rawText = data.reply || "æš‚æ—¶æ²¡æœ‰æ€è·¯ï¼Œè¯·ç›¸ä¿¡ç›´è§‰ã€‚";
            const cleanText = rawText
                .replace(/^AI\s*è¡¥å……[:ï¼š]?\s*/gi, '')
                .replace(/<li>/gi, '\nâ€¢ ')
                .replace(/<br\s*\/?>/gi, '\n')
                .replace(/<\/?(strong|b|i|em|ul|ol|p|div|span)[^>]*>/gi, '')
                .trim();

            hintContent.innerText = cleanText;

        } catch (error) {
            hintContent.innerText = "è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚";
        } finally {
            hintBtn.disabled = false;
            hintBtn.innerText = "ğŸ’¡ æ²¡æ€è·¯ï¼Ÿé—®é—®AIæ€ä¹ˆå†™";
        }
    }

    // ==========================================
    // 3. æ ¸å¿ƒå‡½æ•°ï¼šç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š (è¯·æ±‚ /api/ai)
    // ==========================================
    async function generateReport() {
        formSection.classList.add('hidden');
        reportSection.classList.remove('hidden');
        reportContent.innerHTML = '<div class="loading">æ­£åœ¨æ ¹æ®â€œä¸‰åœ†åœˆæ¨¡å‹â€åˆ†æä½ çš„äººç”Ÿæ•°æ®...<br>è¯·ç¨ç­‰ï¼Œè¿™å¯èƒ½éœ€è¦å‡ åç§’ã€‚</div>';

        // æ•´ç†å†å²æ•°æ®
        const history = questions.map((q, index) => ({
            id: q.id,
            question: q.text,
            answer: answers[index]
        }));

        try {
            // â˜…â˜…â˜… æ³¨æ„è¿™é‡Œï¼šå·²ç»æ”¹æˆäº† /api/ai â˜…â˜…â˜…
            const response = await fetch('/api/ai', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    type: 'report', 
                    history: history 
                }) 
            });

            const data = await response.json();
            reportContent.innerHTML = data.reply; 

        } catch (error) {
            reportContent.innerHTML = '<div class="error">ç”Ÿæˆå¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•ã€‚</div>';
            formSection.classList.remove('hidden');
        }
    }

    // ç•Œé¢æ›´æ–°é€»è¾‘
    function updateUI() {
        const q = questions[currentStep];
        questionText.innerText = `${currentStep + 1}. ${q.text}`;
        stepIndicator.innerText = `é—®é¢˜ ${currentStep + 1} / ${questions.length}`;
        
        // å›æ˜¾ä¹‹å‰çš„ç­”æ¡ˆ
        inputArea.value = answers[currentStep] || '';
        inputArea.focus();

        // éšè—/æ˜¾ç¤º æç¤ºæ¡†
        hintBox.classList.add('hidden');
        hintContent.innerHTML = '';

        // æŒ‰é’®æ˜¾ç¤ºé€»è¾‘
        if (currentStep === 0) {
            prevBtn.classList.add('hidden');
        } else {
            prevBtn.classList.remove('hidden');
        }

        if (currentStep === questions.length - 1) {
            nextBtn.classList.add('hidden');
            submitBtn.classList.remove('hidden');
        } else {
            nextBtn.classList.remove('hidden');
            submitBtn.classList.add('hidden');
        }
        
        // æ›´æ–°ä¸‹ä¸€æ­¥æŒ‰é’®çŠ¶æ€
        const currentVal = inputArea.value.trim();
        if(nextBtn) (nextBtn as HTMLButtonElement).disabled = currentVal === '';
        if(submitBtn) (submitBtn as HTMLButtonElement).disabled = currentVal === '';
    }
</script>
