---
import Layout from '../layouts/Layout.astro';
---

<Layout title="äººç”Ÿä½¿ç”¨è¯´æ˜ä¹¦ - é€»è¾‘æ¨æ¼”ç‰ˆ">
  <main class="container">
    
    <!-- é¡¶éƒ¨æ ‡é¢˜ -->
    <header class="header">
      <h1>äººç”Ÿä½¿ç”¨è¯´æ˜ä¹¦</h1>
      <p class="subtitle">LOGIC KERNEL: DATA FILTERING & SYNTHESIS</p>
    </header>

    <!-- é—®ç­”è¡¨å•åŒºåŸŸ -->
    <section id="form-section" class="form-card">
      <div class="progress-bar">
        <span id="step-indicator">Loading...</span>
      </div>
      
      <div class="question-box">
        <h2 id="question-text">...</h2>
        
        <!-- æç¤ºåŒº -->
        <div class="hint-wrapper">
            <button id="hint-btn" class="hint-btn">ğŸ’¡ æ²¡æ€è·¯ï¼Ÿå‘¼å«è€é«˜</button>
            <div id="hint-box" class="hint-box hidden">
                <div class="hint-content" id="hint-content"></div>
            </div>
        </div>

        <textarea id="answer-input" rows="6" placeholder="..."></textarea>
        
        <div class="nav-buttons">
          <button id="prev-btn" class="btn secondary hidden">ä¸Šä¸€æ­¥</button>
          <button id="next-btn" class="btn primary" disabled>ä¸‹ä¸€æ­¥</button>
          <button id="submit-btn" class="btn accent hidden" disabled>ç”Ÿæˆè¯´æ˜ä¹¦</button>
        </div>
      </div>
    </section>

    <!-- æŠ¥å‘Šç”ŸæˆåŒºåŸŸ -->
    <section id="report-section" class="report-wrapper hidden">
      <div id="report-content">
        <!-- API è¿”å›çš„ HTML å°†ä¼šè¢«æ³¨å…¥åˆ°è¿™é‡Œ -->
      </div>
      
      <div class="action-area">
        <button id="restart-btn" class="btn secondary">é‡æ–°æµ‹è¯•</button>
      </div>
    </section>

  </main>
</Layout>

<script>
    // ==========================================
    // 1. é¢˜ç›®é…ç½® (é€»è¾‘ä¿æŒä¸å˜)
    // ==========================================
    const questions = [
        { id: 1, text: "ä½ å°Šæ•¬çš„äººæ˜¯è°ï¼Ÿ", placeholder: "è€é«˜æç¤ºï¼šå†™ä¸‹åå­—ã€‚ä¸è¦ç®¡ä¼Ÿä¸ä¼Ÿå¤§ï¼Œæƒ³ä»–èº«ä¸Šçš„å½¢å®¹è¯ã€‚", hintPrompt: "æˆ‘ä¸çŸ¥é“å†™è°ï¼Œå¼•å¯¼æˆ‘æ€è€ƒæˆ‘æƒ³æˆä¸ºä»€ä¹ˆæ ·çš„äººã€‚" },
        { id: 2, text: "ä¸ºä»€ä¹ˆå°Šæ•¬ä»–ï¼Ÿ/ å–œæ¬¢ä»–ä»€ä¹ˆåœ°æ–¹ï¼Ÿ", placeholder: "æ ¸å¿ƒé¢˜ï¼šè¿™ä¸ªå½¢å®¹è¯ï¼ˆå¦‚è‡ªç”±ã€è‡ªå¾‹ã€éœ¸æ°”ï¼‰å°±æ˜¯ä½ çš„ä»·å€¼è§‚ã€‚", hintPrompt: "å¼•å¯¼æˆ‘ä»â€˜äººâ€™æŠ½è±¡å‡ºâ€˜å“è´¨â€™ã€‚" },
        { id: 3, text: "é’æ˜¥æœŸå¯¹ä½ å½±å“å¾ˆå¤§çš„äº‹æƒ…ï¼Ÿ", placeholder: "é‚£æ—¶å€™ä½ å¯¹ä»€ä¹ˆæ„Ÿåˆ°æ„¤æ€’æˆ–æ— åŠ›ï¼Ÿåé¢å°±æ˜¯ä½ çš„è¿½æ±‚ã€‚", hintPrompt: "å¼•å¯¼æˆ‘å›å¿†é’æ˜¥æœŸçš„æƒ…ç»ªã€‚" },
        { id: 4, text: "ä½ è§‰å¾—ç°åœ¨ç¤¾ä¼šæœ‰ä»€ä¹ˆä¸è¶³ï¼Ÿ", placeholder: "ä½ æƒ³æ”¹å˜ä¸–ç•Œå“ªé‡Œï¼Ÿé‚£å°±æ˜¯ä½ çš„è´£ä»»æ„Ÿæ‰€åœ¨ã€‚", hintPrompt: "å¼•å¯¼æˆ‘æ€è€ƒç¤¾ä¼šç—›ç‚¹ã€‚" },
        { id: 5, text: "æœ‹å‹è§‰å¾—ä½ çœ‹é‡ä»€ä¹ˆï¼Ÿ", placeholder: "ç›´æ¥é—®æ­»å…šã€‚æ—è§‚è€…æ¸…ã€‚", hintPrompt: "å¼•å¯¼æˆ‘ä»é€šè¿‡åˆ«äººçš„è§†è§’çœ‹è‡ªå·±ã€‚" },
        { id: 6, text: "ç»™èº«è¾¹äººçš„å»ºè®®/ä¸å¸Œæœ›æ”¶åˆ°çš„å»ºè®®ï¼Ÿ", placeholder: "ä½ åŠåˆ«äººçš„è¯ï¼Œå°±æ˜¯ä½ çš„åŸåˆ™ã€‚", hintPrompt: "å¼•å¯¼æˆ‘æ€è€ƒæˆ‘çš„å£å¤´ç¦…ã€‚" },
        { id: 7, text: "ç›®å‰äººç”Ÿæœ€å……å®çš„ç»å†ï¼Ÿ", placeholder: "å“ªä»¶äº‹åšèµ·æ¥â€˜åƒå‘¼å¸ä¸€æ ·è‡ªç„¶â€™ï¼Ÿ", hintPrompt: "å¼•å¯¼æˆ‘å¯»æ‰¾å¿ƒæµä½“éªŒã€‚" },
        { id: 8, text: "æœ€è¿‘ä¸€æ¬¡ä¸è€çƒ¦çš„äº‹æƒ…ï¼Ÿ", placeholder: "â˜…å…³é”®é¢˜ï¼šä½ è§‰å¾—ç®€å•åˆ«äººå´åšä¸å¥½ï¼Œè¿™å°±æ˜¯å¤©èµ‹ã€‚", hintPrompt: "å¼•å¯¼æˆ‘åˆ©ç”¨â€˜æ„¤æ€’â€™æŒ–æ˜å¤©èµ‹ã€‚" },
        { id: 9, text: "é—®èº«è¾¹çš„äººè‡ªå·±æ“…é•¿ä»€ä¹ˆï¼Ÿ", placeholder: "ä¸éœ€è¦æ˜¯å¤§æŠ€èƒ½ï¼Œå¯èƒ½åªæ˜¯â€˜å–„äºå€¾å¬â€™æˆ–â€˜ç›´è§‰å‡†â€™ã€‚", hintPrompt: "å¼•å¯¼æˆ‘å¯»æ‰¾æ— æ„è¯†çš„ä¹ æƒ¯ã€‚" },
        { id: 10, text: "æŠ›å¼€é’±ï¼Œä½ æƒ³åšä»€ä¹ˆå·¥ä½œï¼Ÿ", placeholder: "çº¯ç²¹ä¸ºäº†æ‰“å‘æ—¶é—´ï¼Œä½ æƒ³å¹²å˜›ï¼Ÿ", hintPrompt: "å¼•å¯¼æˆ‘å»é™¤é‡‘é’±æ»¤é•œã€‚" },
        { id: 11, text: "ç›®å‰ä¸ºæ­¢åšæˆè¿‡çš„äº‹æƒ…ï¼Ÿ", placeholder: "å¦‚æœè¿™é¢˜éš¾ç­”ï¼Œå†™å†™ä½ çš„ç¼ºç‚¹ï¼ˆå¦‚ååº”æ…¢=ä¸“æ³¨ï¼‰ã€‚", hintPrompt: "å¼•å¯¼æˆ‘æŠŠç¼ºç‚¹è½¬åŒ–ä¸ºç‰¹ç‚¹ã€‚" },
        { id: 12, text: "æ„¿æ„èŠ±é’±å»å­¦çš„ä¸œè¥¿ï¼Ÿ", placeholder: "ç”¨é’±åŒ…æŠ•ç¥¨çš„æœ€çœŸå®ã€‚", hintPrompt: "å¼•å¯¼æˆ‘çœ‹æ¶ˆè´¹è®°å½•ã€‚" },
        { id: 13, text: "ä¹¦æ¶/æ”¶è—å¤¹é‡Œæœ€å¤šçš„å†…å®¹ï¼Ÿ", placeholder: "ä½ çš„æ³¨æ„åŠ›æµå‘äº†å“ªé‡Œï¼Ÿ", hintPrompt: "å¼•å¯¼æˆ‘æ£€æŸ¥ä¿¡æ¯æ‘„å…¥ã€‚" },
        { id: 14, text: "æ›¾ç»â€˜æ‹¯æ•‘â€™è¿‡ä½ çš„å†…å®¹ï¼Ÿ", placeholder: "ä½è°·æœŸæ˜¯è°æ‹‰äº†ä½ ä¸€æŠŠï¼Ÿ", hintPrompt: "å¼•å¯¼æˆ‘å¯»æ‰¾ç²¾ç¥æ”¯æŸ±ã€‚" },
        { id: 15, text: "æƒ³è¦æ„Ÿè°¢çš„äººæˆ–äº‹ï¼Ÿ", placeholder: "æ„Ÿæ©çš„æºå¤´è—ç€çƒ­æƒ…ã€‚", hintPrompt: "å¼•å¯¼æˆ‘æ€è€ƒæ„Ÿæ©ã€‚" },
        { id: 16, text: "ä½ å¯¹è¿™ä¸ªä¸–ç•Œæœ‰ä»€ä¹ˆä¸æ»¡ï¼Ÿ", placeholder: "ä½ æƒ³è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿï¼ˆå¦‚ï¼šæƒ³è®©äº¤é€šæ›´é¡ºç•…ï¼‰ã€‚", hintPrompt: "å¼•å¯¼æˆ‘æ€è€ƒå®å¤§çš„æ„¿æœ›ã€‚" }
    ];

    let currentStep = 0;
    const answers = new Array(questions.length).fill('');
    
    // ==========================================
    // 2. è·å– DOM å…ƒç´  (å•ç‹¬å®šä¹‰ï¼Œæ˜¾å¼ç±»å‹è½¬æ¢ï¼Œä¸å†æ‰“åŒ…)
    // ==========================================
    const stepText = document.getElementById('step-indicator');
    const qText = document.getElementById('question-text');
    // æ˜¾å¼å‘Šè¯‰ TSï¼šè¿™è‚¯å®šæ˜¯ textareaï¼Œæˆ–è€…æ˜¯ null
    const inputArea = document.getElementById('answer-input') as HTMLTextAreaElement | null;
    const prevBtn = document.getElementById('prev-btn') as HTMLButtonElement | null;
    const nextBtn = document.getElementById('next-btn') as HTMLButtonElement | null;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement | null;
    
    const hintBtn = document.getElementById('hint-btn') as HTMLButtonElement | null;
    const hintBox = document.getElementById('hint-box');
    const hintContent = document.getElementById('hint-content');
    
    const formSection = document.getElementById('form-section');
    const reportSection = document.getElementById('report-section');
    const reportContent = document.getElementById('report-content');
    const restartBtn = document.getElementById('restart-btn') as HTMLButtonElement | null;

    // åˆå§‹åŒ–ç•Œé¢
    renderUI();

    // ==========================================
    // 3. äº‹ä»¶ç›‘å¬ (æ¯ä¸€æ­¥éƒ½åšéç©ºæ£€æŸ¥)
    // ==========================================
    
    if (inputArea) {
        inputArea.addEventListener('input', (e) => {
            const target = e.target as HTMLTextAreaElement;
            answers[currentStep] = target.value;
            checkBtnState();
        });
    }

    if (nextBtn) {
        nextBtn.addEventListener('click', () => {
            if(currentStep < questions.length - 1) {
                currentStep++;
                renderUI();
            }
        });
    }

    if (prevBtn) {
        prevBtn.addEventListener('click', () => {
            if(currentStep > 0) {
                currentStep--;
                renderUI();
            }
        });
    }

    if (restartBtn) {
        restartBtn.addEventListener('click', () => {
            location.reload();
        });
    }

    if (hintBtn) {
        hintBtn.addEventListener('click', async () => {
            const q = questions[currentStep];
            if (hintBtn) {
                hintBtn.disabled = true;
                hintBtn.innerText = "è€é«˜æ­£åœ¨æ€è€ƒ...";
            }
            if (hintBox) hintBox.classList.remove('hidden');
            if (hintContent) hintContent.innerHTML = "æ­£åœ¨è¿æ¥æ€ç»´åº“...";
            
            try {
                const res = await fetch('/api/ai', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type: 'hint', prompt: q.hintPrompt })
                });
                const data = await res.json();
                if (hintContent) hintContent.innerText = data.reply;
            } catch(e) {
                if (hintContent) hintContent.innerText = "è¿æ¥è¶…æ—¶";
            }
            
            if (hintBtn) {
                hintBtn.disabled = false;
                hintBtn.innerText = "ğŸ’¡ æ²¡æ€è·¯ï¼Ÿå‘¼å«è€é«˜";
            }
        });
    }

    if (submitBtn) {
        submitBtn.addEventListener('click', async () => {
            if (formSection) formSection.classList.add('hidden');
            if (reportSection) reportSection.classList.remove('hidden');
            
            if (reportContent) {
                reportContent.innerHTML = `
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <h3>æ­£åœ¨è¿›è¡Œé€»è¾‘æ¨æ¼”...</h3>
                        <p>1. æå–ä»·å€¼è§‚/æ‰èƒ½/çƒ­æƒ…å…³é”®è¯...</p>
                        <p>2. ç¼ºç‚¹è½¬åŒ– & å¤©èµ‹åè½¬è®¡ç®—...</p>
                        <p>3. åˆæˆèŒä¸šé€‰é¡¹ & ä»·å€¼è§‚è¿‡æ»¤...</p>
                    </div>
                `;
            }

            const history = questions.map((q, i) => ({
                id: q.id, question: q.text, answer: answers[i]
            }));

            try {
                const res = await fetch('/api/ai', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type: 'report', history })
                });
                const data = await res.json();
                // â˜… æ ¸å¿ƒé€»è¾‘ï¼šç›´æ¥æ³¨å…¥ API è¿”å›çš„ HTML
                if (reportContent) reportContent.innerHTML = data.reply;
            } catch(e) {
                if (reportContent) reportContent.innerHTML = "<h3>ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</h3>";
                if (formSection) formSection.classList.remove('hidden');
            }
        });
    }

    // ==========================================
    // 4. ç•Œé¢æ›´æ–°å‡½æ•°
    // ==========================================
    function renderUI() {
        const q = questions[currentStep];
        if (stepText) stepText.innerText = `Question ${currentStep + 1} / ${questions.length}`;
        if (qText) qText.innerText = q.text;
        
        if (inputArea) {
            inputArea.value = answers[currentStep] || '';
            inputArea.placeholder = q.placeholder;
            inputArea.focus();
        }

        if (hintBox) hintBox.classList.add('hidden');
        
        if (prevBtn) prevBtn.classList.toggle('hidden', currentStep === 0);
        
        const isLast = currentStep === questions.length - 1;
        if (nextBtn) nextBtn.classList.toggle('hidden', isLast);
        if (submitBtn) submitBtn.classList.toggle('hidden', !isLast);
        
        checkBtnState();
    }

    function checkBtnState() {
        if (inputArea) {
            const val = inputArea.value.trim();
            const empty = !val;
            if (nextBtn) nextBtn.disabled = empty;
            if (submitBtn) submitBtn.disabled = empty;
        }
    }
</script>

<style is:global>
    /* å…¨å±€åŸºç¡€æ ·å¼ */
    :root {
        --bg: #f8f9fa;
        --card-bg: #ffffff;
        --primary: #2d3436;
        --accent: #6c5ce7;
        --text: #2d3436;
        --gray: #b2bec3;
        --border-radius: 16px;
    }

    body {
        background-color: var(--bg);
        font-family: 'Inter', system-ui, sans-serif;
        color: var(--text);
        line-height: 1.6;
    }

    .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 40px 20px;
    }

    .header {
        text-align: center;
        margin-bottom: 40px;
    }
    .header h1 { font-size: 2.5rem; margin-bottom: 10px; letter-spacing: -1px; }
    .subtitle { color: var(--gray); font-size: 0.9rem; letter-spacing: 1px; text-transform: uppercase; }

    /* å¡ç‰‡å®¹å™¨ */
    .form-card, .report-wrapper {
        background: var(--card-bg);
        padding: 40px;
        border-radius: var(--border-radius);
        box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    }

    /* éšè—å·¥å…·ç±» */
    .hidden { display: none !important; }

    /* è¾“å…¥æ¡†ä¸æŒ‰é’® */
    textarea {
        width: 100%;
        padding: 20px;
        border: 2px solid #eee;
        border-radius: 12px;
        font-size: 1.1rem;
        resize: none;
        transition: all 0.3s;
        margin: 20px 0;
        font-family: inherit;
    }
    textarea:focus { outline: none; border-color: var(--primary); }

    .nav-buttons { display: flex; gap: 10px; margin-top: 20px; }
    .btn {
        padding: 12px 24px;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        flex: 1;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn.primary { background: var(--primary); color: white; }
    .btn.secondary { background: #eee; color: #666; }
    .btn.accent { background: var(--accent); color: white; }

    /* æç¤ºæ¡† */
    .hint-wrapper { margin: 10px 0; }
    .hint-btn { background: none; border: none; color: var(--accent); cursor: pointer; font-size: 0.9rem; }
    .hint-box { background: #f0f0ff; padding: 15px; border-radius: 8px; margin-top: 10px; font-size: 0.95rem; color: #555; }

    /* ==========================================
       â˜… é‡ç‚¹ï¼šæ–°ç‰ˆæŠ¥å‘Šçš„ CSS æ ·å¼
       ========================================== */
    
    .report-container { animation: fadeIn 0.8s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .step-section { margin-bottom: 40px; padding-bottom: 30px; border-bottom: 1px solid #eee; }
    .step-section:last-child { border-bottom: none; }

    .report-title { font-size: 1.4rem; font-weight: 800; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
    .section-intro { color: #666; margin-bottom: 20px; }

    /* 1. å…³é”®è¯æå–æ ¼æ … */
    .keywords-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
    .keyword-col { background: #f8f9fa; padding: 20px; border-radius: 12px; }
    .keyword-col h3 { font-size: 1.1rem; margin-bottom: 5px; color: #333; }
    .keyword-col .subtitle { font-size: 0.8rem; color: #888; margin-bottom: 15px; }
    .tags-list { display: flex; flex-wrap: wrap; gap: 8px; }
    
    .tag-pill {
        background: white;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        border: 1px solid #eee;
    }
    .keyword-col:nth-child(1) .tag-pill { color: #e17055; border-color: #fab1a0; } /* ä»·å€¼è§‚çº¢ */
    .keyword-col:nth-child(2) .tag-pill { color: #0984e3; border-color: #74b9ff; } /* æ‰èƒ½è“ */
    .keyword-col:nth-child(3) .tag-pill { color: #00b894; border-color: #55efc4; } /* çƒ­æƒ…ç»¿ */

    .small-tip { font-size: 0.75rem; color: #636e72; margin-top: 10px; font-style: italic; }

    /* 2. è®¡ç®—å…¬å¼ç›’å­ */
    .calc-box {
        background: #2d3436;
        color: white;
        padding: 25px;
        border-radius: 12px;
        font-size: 1.1rem;
        text-align: center;
        line-height: 1.8;
    }
    .math-item { border-bottom: 2px solid rgba(255,255,255,0.3); padding: 0 5px; }

    /* 3. è¿‡æ»¤è¿‡ç¨‹ (Pass/Fail) */
    .filter-process { display: flex; flex-direction: column; gap: 15px; }
    .filter-row {
        padding: 15px;
        border-radius: 10px;
        border-left: 4px solid #ccc;
    }
    .filter-row.fail { background: #fff5f5; border-left-color: #fab1a0; }
    .filter-row.pass { background: #f0fff4; border-left-color: #55efc4; }
    
    .filter-header { font-weight: 700; margin-bottom: 5px; }
    .filter-reason { font-size: 0.9rem; color: #555; }

    /* 4. æœ€ç»ˆç»“è®ºå¡ç‰‡ */
    .final-card {
        background: linear-gradient(135deg, #6c5ce7, #a29bfe);
        color: white;
        padding: 30px;
        border-radius: 16px;
        text-align: center;
        box-shadow: 0 10px 20px rgba(108, 92, 231, 0.3);
    }
    .final-statement { font-size: 1.5rem; font-weight: 800; margin: 20px 0; line-height: 1.4; }
    .logic-summary { font-size: 0.9rem; opacity: 0.8; }

    .laogao-notes {
        margin-top: 30px;
        background: #fff3cd;
        padding: 20px;
        border-radius: 10px;
        font-size: 0.9rem;
        color: #856404;
    }
    .laogao-notes ul { padding-left: 20px; margin: 10px 0; }

    /* Loading åŠ¨ç”» */
    .loading-state { text-align: center; padding: 40px; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
