---
import Layout from '../layouts/Layout.astro';
---

<Layout title="äººç”Ÿä½¿ç”¨è¯´æ˜ä¹¦ - é€»è¾‘æ¨æ¼”ç‰ˆ">
  <main class="container">
    <header class="header">
      <h1>äººç”Ÿä½¿ç”¨è¯´æ˜ä¹¦</h1>
      <p class="subtitle">LOGIC KERNEL: DATA FILTERING & SYNTHESIS</p>
    </header>

    <section id="form-section" class="form-card">
      <div class="progress-bar">
        <span id="step-indicator">Loading...</span>
      </div>
      
      <div class="question-box">
        <h2 id="question-text">...</h2>

        <div class="hint-wrapper">
          <button id="hint-btn" class="hint-btn">ğŸ’¡ æ²¡æ€è·¯ï¼Ÿå‘¼å«è€é«˜</button>
          <div id="hint-box" class="hint-box hidden">
            <div id="hint-content" class="hint-content"></div>
          </div>
        </div>

        <textarea id="answer-input" rows="6" placeholder="..."></textarea>
        
        <div class="nav-buttons">
          <button id="prev-btn" class="btn secondary hidden">ä¸Šä¸€æ­¥</button>
          <button id="next-btn" class="btn primary" disabled>ä¸‹ä¸€æ­¥</button>
          <button id="submit-btn" class="btn accent hidden" disabled>ç”Ÿæˆè¯´æ˜ä¹¦</button>
        </div>
      </div>
    </section>

    <section id="report-section" class="report-wrapper hidden">
      <div id="report-content"></div>
      <div class="action-area">
        <button id="restart-btn" class="btn secondary">é‡æ–°æµ‹è¯•</button>
      </div>
    </section>
  </main>

  <!-- åªå†™çº¯ JavaScriptï¼Œæ²¡æœ‰ä»»ä½• TypeScript è¯­æ³• -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var questions = [
        { id: 1, text: "ä½ å°Šæ•¬çš„äººæ˜¯è°ï¼Ÿ", placeholder: "è€é«˜æç¤ºï¼šå†™ä¸‹åå­—ã€‚ä¸è¦ç®¡ä¼Ÿä¸ä¼Ÿå¤§ï¼Œæƒ³ä»–èº«ä¸Šçš„å½¢å®¹è¯ã€‚", hintPrompt: "æˆ‘ä¸çŸ¥é“å†™è°ï¼Œå¼•å¯¼æˆ‘æ€è€ƒæˆ‘æƒ³æˆä¸ºä»€ä¹ˆæ ·çš„äººã€‚" },
        { id: 2, text: "ä¸ºä»€ä¹ˆå°Šæ•¬ä»–ï¼Ÿ/ å–œæ¬¢ä»–ä»€ä¹ˆåœ°æ–¹ï¼Ÿ", placeholder: "æ ¸å¿ƒé¢˜ï¼šè¿™ä¸ªå½¢å®¹è¯ï¼ˆå¦‚è‡ªç”±ã€è‡ªå¾‹ã€éœ¸æ°”ï¼‰å°±æ˜¯ä½ çš„ä»·å€¼è§‚ã€‚", hintPrompt: "å¼•å¯¼æˆ‘ä»â€˜äººâ€™æŠ½è±¡å‡ºâ€˜å“è´¨â€™ã€‚" },
        { id: 3, text: "é’æ˜¥æœŸå¯¹ä½ å½±å“å¾ˆå¤§çš„äº‹æƒ…ï¼Ÿ", placeholder: "é‚£æ—¶å€™ä½ å¯¹ä»€ä¹ˆæ„Ÿåˆ°æ„¤æ€’æˆ–æ— åŠ›ï¼Ÿåé¢å°±æ˜¯ä½ çš„è¿½æ±‚ã€‚", hintPrompt: "å¼•å¯¼æˆ‘å›å¿†é’æ˜¥æœŸçš„æƒ…ç»ªã€‚" },
        { id: 4, text: "ä½ è§‰å¾—ç°åœ¨ç¤¾ä¼šæœ‰ä»€ä¹ˆä¸è¶³ï¼Ÿ", placeholder: "ä½ æƒ³æ”¹å˜ä¸–ç•Œå“ªé‡Œï¼Ÿé‚£å°±æ˜¯ä½ çš„è´£ä»»æ„Ÿæ‰€åœ¨ã€‚", hintPrompt: "å¼•å¯¼æˆ‘æ€è€ƒç¤¾ä¼šç—›ç‚¹ã€‚" },
        { id: 5, text: "æœ‹å‹è§‰å¾—ä½ çœ‹é‡ä»€ä¹ˆï¼Ÿ", placeholder: "ç›´æ¥é—®æ­»å…šã€‚æ—è§‚è€…æ¸…ã€‚", hintPrompt: "å¼•å¯¼æˆ‘ä»é€šè¿‡åˆ«äººçš„è§†è§’çœ‹è‡ªå·±ã€‚" },
        { id: 6, text: "ç»™èº«è¾¹äººçš„å»ºè®®/ä¸å¸Œæœ›æ”¶åˆ°çš„å»ºè®®ï¼Ÿ", placeholder: "ä½ åŠåˆ«äººçš„è¯ï¼Œå°±æ˜¯ä½ çš„åŸåˆ™ã€‚", hintPrompt: "å¼•å¯¼æˆ‘æ€è€ƒæˆ‘çš„å£å¤´ç¦…ã€‚" },
        { id: 7, text: "ç›®å‰äººç”Ÿæœ€å……å®çš„ç»å†ï¼Ÿ", placeholder: "å“ªä»¶äº‹åšèµ·æ¥â€˜åƒå‘¼å¸ä¸€æ ·è‡ªç„¶â€™ï¼Ÿ", hintPrompt: "å¼•å¯¼æˆ‘å¯»æ‰¾å¿ƒæµä½“éªŒã€‚" },
        { id: 8, text: "æœ€è¿‘ä¸€æ¬¡ä¸è€çƒ¦çš„äº‹æƒ…ï¼Ÿ", placeholder: "â˜…å…³é”®é¢˜ï¼šä½ è§‰å¾—ç®€å•åˆ«äººå´åšä¸å¥½ï¼Œè¿™å°±æ˜¯å¤©èµ‹ã€‚", hintPrompt: "å¼•å¯¼æˆ‘åˆ©ç”¨â€˜æ„¤æ€’â€™æŒ–æ˜å¤©èµ‹ã€‚" },
        { id: 9, text: "é—®èº«è¾¹çš„äººè‡ªå·±æ“…é•¿ä»€ä¹ˆï¼Ÿ", placeholder: "ä¸éœ€è¦æ˜¯å¤§æŠ€èƒ½ï¼Œå¯èƒ½åªæ˜¯â€˜å–„äºå€¾å¬â€™æˆ–â€˜ç›´è§‰å‡†â€™ã€‚", hintPrompt: "å¼•å¯¼æˆ‘å¯»æ‰¾æ— æ„è¯†çš„ä¹ æƒ¯ã€‚" },
        { id: 10, text: "æŠ›å¼€é’±ï¼Œä½ æƒ³åšä»€ä¹ˆå·¥ä½œï¼Ÿ", placeholder: "çº¯ç²¹ä¸ºäº†æ‰“å‘æ—¶é—´ï¼Œä½ æƒ³å¹²å˜›ï¼Ÿ", hintPrompt: "å¼•å¯¼æˆ‘å»é™¤é‡‘é’±æ»¤é•œã€‚" },
        { id: 11, text: "ç›®å‰ä¸ºæ­¢åšæˆè¿‡çš„äº‹æƒ…ï¼Ÿ", placeholder: "å¦‚æœè¿™é¢˜éš¾ç­”ï¼Œå†™å†™ä½ çš„ç¼ºç‚¹ï¼ˆå¦‚ååº”æ…¢=ä¸“æ³¨ï¼‰ã€‚", hintPrompt: "å¼•å¯¼æˆ‘æŠŠç¼ºç‚¹è½¬åŒ–ä¸ºç‰¹ç‚¹ã€‚" },
        { id: 12, text: "æ„¿æ„èŠ±é’±å»å­¦çš„ä¸œè¥¿ï¼Ÿ", placeholder: "ç”¨é’±åŒ…æŠ•ç¥¨çš„æœ€çœŸå®ã€‚", hintPrompt: "å¼•å¯¼æˆ‘çœ‹æ¶ˆè´¹è®°å½•ã€‚" },
        { id: 13, text: "ä¹¦æ¶/æ”¶è—å¤¹é‡Œæœ€å¤šçš„å†…å®¹ï¼Ÿ", placeholder: "ä½ çš„æ³¨æ„åŠ›æµå‘äº†å“ªé‡Œï¼Ÿ", hintPrompt: "å¼•å¯¼æˆ‘æ£€æŸ¥ä¿¡æ¯æ‘„å…¥ã€‚" },
        { id: 14, text: "æ›¾ç»â€˜æ‹¯æ•‘â€™è¿‡ä½ çš„å†…å®¹ï¼Ÿ", placeholder: "ä½è°·æœŸæ˜¯è°æ‹‰äº†ä½ ä¸€æŠŠï¼Ÿ", hintPrompt: "å¼•å¯¼æˆ‘å¯»æ‰¾ç²¾ç¥æ”¯æŸ±ã€‚" },
        { id: 15, text: "æƒ³è¦æ„Ÿè°¢çš„äººæˆ–äº‹ï¼Ÿ", placeholder: "æ„Ÿæ©çš„æºå¤´è—ç€çƒ­æƒ…ã€‚", hintPrompt: "å¼•å¯¼æˆ‘æ€è€ƒæ„Ÿæ©ã€‚" },
        { id: 16, text: "ä½ å¯¹è¿™ä¸ªä¸–ç•Œæœ‰ä»€ä¹ˆä¸æ»¡ï¼Ÿ", placeholder: "ä½ æƒ³è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿï¼ˆå¦‚ï¼šæƒ³è®©äº¤é€šæ›´é¡ºç•…ï¼‰ã€‚", hintPrompt: "å¼•å¯¼æˆ‘æ€è€ƒå®å¤§çš„æ„¿æœ›ã€‚" }
      ];

      var currentStep = 0;
      var answers = new Array(questions.length).fill('');

      // DOM å¼•ç”¨
      var stepText     = document.getElementById('step-indicator');
      var qText        = document.getElementById('question-text');
      var inputArea    = document.getElementById('answer-input');
      var prevBtn      = document.getElementById('prev-btn');
      var nextBtn      = document.getElementById('next-btn');
      var submitBtn    = document.getElementById('submit-btn');
      var hintBtn      = document.getElementById('hint-btn');
      var hintBox      = document.getElementById('hint-box');
      var hintContent  = document.getElementById('hint-content');
      var formSection  = document.getElementById('form-section');
      var reportSection= document.getElementById('report-section');
      var reportContent= document.getElementById('report-content');
      var restartBtn   = document.getElementById('restart-btn');

      if (!stepText || !qText || !inputArea) {
        // é¡µé¢ç»“æ„ä¸å®Œæ•´ï¼Œç›´æ¥è¿”å›ï¼Œé¿å…æŠ¥é”™
        return;
      }

      function updateUI() {
        var q = questions[currentStep];

        stepText.textContent = 'Question ' + (currentStep + 1) + ' / ' + questions.length;
        qText.textContent = q.text;

        inputArea.value = answers[currentStep] || '';
        inputArea.placeholder = q.placeholder || '';
        inputArea.focus();

        if (hintBox) hintBox.classList.add('hidden');

        if (prevBtn) {
          if (currentStep === 0) prevBtn.classList.add('hidden');
          else prevBtn.classList.remove('hidden');
        }

        var isLast = currentStep === questions.length - 1;
        if (nextBtn) {
          if (isLast) nextBtn.classList.add('hidden');
          else nextBtn.classList.remove('hidden');
        }
        if (submitBtn) {
          if (!isLast) submitBtn.classList.add('hidden');
          else submitBtn.classList.remove('hidden');
        }

        checkState();
      }

      function checkState() {
        var val = inputArea.value.trim();
        var empty = val === '';
        if (nextBtn) nextBtn.disabled = empty;
        if (submitBtn) submitBtn.disabled = empty;
      }

      // äº‹ä»¶ç»‘å®š
      inputArea.addEventListener('input', function (e) {
        answers[currentStep] = e.target.value;
        checkState();
      });

      if (nextBtn) {
        nextBtn.addEventListener('click', function () {
          if (currentStep < questions.length - 1) {
            currentStep++;
            updateUI();
          }
        });
      }

      if (prevBtn) {
        prevBtn.addEventListener('click', function () {
          if (currentStep > 0) {
            currentStep--;
            updateUI();
          }
        });
      }

      if (hintBtn) {
        hintBtn.addEventListener('click', function () {
          var q = questions[currentStep];

          hintBtn.disabled = true;
          hintBtn.textContent = 'è€é«˜æ­£åœ¨æ€è€ƒ...';

          if (hintBox) hintBox.classList.remove('hidden');
          if (hintContent) hintContent.textContent = 'æ­£åœ¨è¿æ¥æ€ç»´åº“...';

          fetch('/api/ai', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: 'hint', prompt: q.hintPrompt })
          })
            .then(function (res) { return res.json(); })
            .then(function (data) {
              if (hintContent) hintContent.textContent = data.reply;
            })
            .catch(function () {
              if (hintContent) hintContent.textContent = 'è¿æ¥è¶…æ—¶';
            })
            .finally(function () {
              hintBtn.disabled = false;
              hintBtn.textContent = 'ğŸ’¡ æ²¡æ€è·¯ï¼Ÿå‘¼å«è€é«˜';
            });
        });
      }

      if (submitBtn) {
        submitBtn.addEventListener('click', function () {
          if (formSection) formSection.classList.add('hidden');
          if (reportSection) reportSection.classList.remove('hidden');

          if (reportContent) {
            reportContent.innerHTML =
              '<div class="loading-state">' +
              '<div class="spinner"></div>' +
              '<h3>æ­£åœ¨è¿›è¡Œé€»è¾‘æ¨æ¼”...</h3>' +
              '<p>1. æå–ä»·å€¼è§‚/æ‰èƒ½/çƒ­æƒ…å…³é”®è¯...</p>' +
              '<p>2. ç¼ºç‚¹è½¬åŒ– & å¤©èµ‹åè½¬è®¡ç®—...</p>' +
              '<p>3. åˆæˆèŒä¸šé€‰é¡¹ & ä»·å€¼è§‚è¿‡æ»¤...</p>' +
              '</div>';
          }

          var history = questions.map(function (q, i) {
            return { id: q.id, question: q.text, answer: answers[i] };
          });

          fetch('/api/ai', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: 'report', history: history })
          })
            .then(function (res) { return res.json(); })
            .then(function (data) {
              if (reportContent) reportContent.innerHTML = data.reply;
            })
            .catch(function () {
              if (reportContent) reportContent.innerHTML = '<h3>ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</h3>';
              if (formSection) formSection.classList.remove('hidden');
            });
        });
      }

      if (restartBtn) {
        restartBtn.addEventListener('click', function () {
          location.reload();
        });
      }

      // åˆå§‹åŒ–
      updateUI();
    });
  </script>

  <style is:global>
    :root {
      --bg: #f8f9fa;
      --card-bg: #ffffff;
      --primary: #2d3436;
      --accent: #6c5ce7;
      --text: #2d3436;
      --gray: #b2bec3;
      --border-radius: 16px;
    }

    body {
      background-color: var(--bg);
      font-family: 'Inter', system-ui, sans-serif;
      color: var(--text);
      line-height: 1.6;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      letter-spacing: -1px;
    }

    .subtitle {
      color: var(--gray);
      font-size: 0.9rem;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .form-card,
    .report-wrapper {
      background: var(--card-bg);
      padding: 40px;
      border-radius: var(--border-radius);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
    }

    .hidden {
      display: none !important;
    }

    textarea {
      width: 100%;
      padding: 20px;
      border: 2px solid #eee;
      border-radius: 12px;
      font-size: 1.1rem;
      resize: none;
      margin: 20px 0;
    }

    textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    .nav-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .btn {
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      flex: 1;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn.primary {
      background: var(--primary);
      color: white;
    }

    .btn.secondary {
      background: #eee;
      color: #666;
    }

    .btn.accent {
      background: var(--accent);
      color: white;
    }

    .hint-wrapper {
      margin: 10px 0;
    }

    .hint-btn {
      background: none;
      border: none;
      color: var(--accent);
      cursor: pointer;
      font-size: 0.9rem;
    }

    .hint-box {
      background: #f0f0ff;
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 0.95rem;
      color: #555;
    }

    /* æŠ¥å‘Šå±•ç¤ºç”¨æ ·å¼ï¼ˆå’Œä¹‹å‰ä¸€è‡´ï¼‰ */
    .report-container {
      animation: fadeIn 0.8s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .step-section {
      margin-bottom: 40px;
      padding-bottom: 30px;
      border-bottom: 1px solid #eee;
    }

    .report-title {
      font-size: 1.4rem;
      font-weight: 800;
      margin-bottom: 20px;
    }

    .keywords-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }

    .keyword-col {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
    }

    .tag-pill {
      background: white;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.85rem;
      border: 1px solid #eee;
      display: inline-block;
      margin: 3px;
    }

    .keyword-col:nth-child(1) .tag-pill {
      color: #e17055;
      border-color: #fab1a0;
    }

    .keyword-col:nth-child(2) .tag-pill {
      color: #0984e3;
      border-color: #74b9ff;
    }

    .keyword-col:nth-child(3) .tag-pill {
      color: #00b894;
      border-color: #55efc4;
    }

    .calc-box {
      background: #2d3436;
      color: white;
      padding: 25px;
      border-radius: 12px;
      text-align: center;
    }

    .filter-process {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .filter-row {
      padding: 15px;
      border-radius: 10px;
      border-left: 4px solid #ccc;
    }

    .filter-row.fail {
      background: #fff5f5;
      border-left-color: #fab1a0;
    }

    .filter-row.pass {
      background: #f0fff4;
      border-left-color: #55efc4;
    }

    .final-card {
      background: linear-gradient(135deg, #6c5ce7, #a29bfe);
      color: white;
      padding: 30px;
      border-radius: 16px;
      text-align: center;
    }

    .final-statement {
      font-size: 1.5rem;
      font-weight: 800;
      margin: 20px 0;
    }

    .laogao-notes {
      margin-top: 30px;
      background: #fff3cd;
      padding: 20px;
      border-radius: 10px;
      font-size: 0.9rem;
      color: #856404;
    }

    .loading-state {
      text-align: center;
      padding: 40px;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</Layout>
